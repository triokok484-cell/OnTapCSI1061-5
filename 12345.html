<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI FPTU - Công cụ Ôn tập Nâng cao</title>
    <style>
        :root {
            --fpt-blue: #0055a5;
            --fpt-orange: #f26f21;
            --info-blue: #007bff;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --highlight-bg: #fff3cd;
            --highlight-text: #856404;
            --correct-bg: #d4edda;
            --correct-border: #c3e6cb;
            --incorrect-bg: #f8d7da;
            --incorrect-border: #f5c6cb;
            --explanation-bg: #e2e3e5;
        }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
            line-height: 1.7;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .container {
            max-width: 960px;
            margin: auto;
            background: var(--container-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        header {
            text-align: center;
            border-bottom: 3px solid var(--fpt-blue);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        header h1 {
            color: var(--fpt-blue);
            margin: 0 0 5px 0;
        }
        .lang-switcher {
            margin-top: 15px;
        }
        .lang-switcher button {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            margin: 0 5px;
            border-radius: 5px;
            font-size: 14px;
        }
        .lang-switcher button.active {
            background-color: var(--fpt-blue);
            color: white;
            border-color: var(--fpt-blue);
        }
        .tab-nav {
            display: flex;
            margin-bottom: 25px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-link {
            flex: 1;
            padding: 15px;
            cursor: pointer;
            border: none;
            background-color: #e9ecef;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
            text-align: center;
        }
        .tab-link.active {
            background-color: var(--fpt-orange);
            color: white;
        }
        .tab-link:hover:not(.active) {
            background-color: #dee2e6;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .theory-content h2 { color: var(--fpt-blue); border-bottom: 2px solid var(--fpt-orange); padding-bottom: 5px; }
        .theory-content h3 { color: #333; margin-top: 25px; }
        .theory-content h4 { color: #555; margin-top: 20px; }
        .theory-content ul { list-style-type: none; padding-left: 0; }
        .theory-content li { background: #f8f9fa; margin-bottom: 10px; padding: 15px; border-left: 4px solid var(--fpt-blue); border-radius: 5px; }
        .theory-content ul ul { margin-top: 10px; }
        .theory-content li li { background: #e9ecef; border-left-color: var(--fpt-orange); }
        .theory-content code, .theory-content pre {
            font-family: Consolas, 'Courier New', monospace;
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 4px;
        }
        .theory-content pre {
            padding: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-left: 4px solid #ccc;
        }

        .highlight {
            background-color: var(--highlight-bg);
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: var(--highlight-text);
        }
        .quiz-view, .quiz-setup, .quiz-results { display: none; }
        .quiz-container, .quiz-setup, .quiz-results {
            border: 1px solid #dee2e6;
            padding: 25px;
            margin-top: 25px;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .quiz-question {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .quiz-options button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 14px;
            margin: 8px 0;
            border: 1px solid #ccc;
            background-color: var(--container-bg);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 16px;
        }
        .quiz-options button:hover:not([disabled]) {
            background-color: #e9e9e9;
            border-color: #aaa;
        }
        .quiz-options button.correct {
            background-color: var(--correct-bg);
            border-color: var(--correct-border);
            font-weight: bold;
        }
        .quiz-options button.incorrect {
            background-color: var(--incorrect-bg);
            border-color: var(--incorrect-border);
        }
        .explanation-box {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--explanation-bg);
            border-radius: 6px;
            border: 1px solid #ced4da;
        }
        .button-group button, .quiz-setup button, .quiz-results button, .quiz-setup input {
            padding: 12px 22px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            margin: 10px 5px 10px 0;
            border: none;
            font-weight: 500;
        }
        .quiz-setup input {
            width: 80px;
            border: 1px solid #ccc;
            border-radius: 6px;
            text-align: center;
        }
        .primary-button { background-color: var(--fpt-blue); color: white; }
        .secondary-button { background-color: #6c757d; color: white; }
        .info-button { background-color: var(--info-blue); color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 data-lang-key="title">CSI FPTU - Công cụ Ôn tập Nâng cao</h1>
            <p data-lang-key="subtitle">Chọn chương để học lý thuyết hoặc làm bài tập trắc nghiệm.</p>
            <div class="lang-switcher">
                <button onclick="switchLanguage('vi')" class="active" data-lang-key="vietnamese">Tiếng Việt</button>
                <button onclick="switchLanguage('en')" data-lang-key="english">English</button>
            </div>
        </header>

        <div class="tab-nav">
            <button class="tab-link active" onclick="switchTab('chapter1')" data-lang-key="ch1">Chương 1</button>
            <button class="tab-link" onclick="switchTab('chapter2')" data-lang-key="ch2">Chương 2</button>
            <button class="tab-link" onclick="switchTab('chapter3')" data-lang-key="ch3">Chương 3</button>
            <button class="tab-link" onclick="switchTab('chapter4')" data-lang-key="ch4">Chương 4</button>
            <button class="tab-link" onclick="switchTab('chapter5')" data-lang-key="ch5">Chương 5</button>
        </div>

        <div class="tab-content">
            <!-- Content will be generated by JavaScript -->
        </div>
    </div>

    <script>
        // --- START: NGÂN HÀNG CÂU HỎI VÀ LÝ THUYẾT ---
        const contentData = {
            chapter1: {
                theory: {
                    vi: `
                        <h2>Chương 1: Giới thiệu Tổng quan</h2>
                        <h3>1. Các mô hình máy tính cơ bản</h3>
                        <ul>
                            <li>
                                <strong>Mô hình Turing (Turing Model):</strong>
                                <ul>
                                    <li>Định nghĩa máy tính như một <span class="highlight">bộ xử lý dữ liệu có thể lập trình được (programmable data processor)</span>.</li>
                                    <li>Đây là một mô hình lý thuyết, toán học, không phải kiến trúc vật lý.</li>
                                    <li>Công thức cốt lõi: <strong>Dữ liệu đầu vào + Chương trình -> Máy tính -> Dữ liệu đầu ra</strong>.</li>
                                </ul>
                            </li>
                            <li>
                                <strong>Mô hình von Neumann (von Neumann Model):</strong>
                                <ul>
                                    <li>Mô hình kiến trúc cho hầu hết các máy tính hiện đại.</li>
                                    <li><span class="highlight">Khái niệm đột phá: Chương trình được lưu trong bộ nhớ (Stored Program Concept)</span>. Cả chương trình và dữ liệu đều được lưu trữ trong cùng một bộ nhớ và có cùng định dạng (nhị phân).</li>
                                </ul>
                            </li>
                        </ul>
                    `,
                    en: `
                        <h2>Chapter 1: Introduction</h2>
                        <h3>1. Basic Computer Models</h3>
                        <ul>
                            <li>
                                <strong>Turing Model:</strong>
                                <ul>
                                    <li>Defines a computer as a <span class="highlight">programmable data processor</span>.</li>
                                    <li>This is a theoretical, mathematical model, not a physical architecture.</li>
                                    <li>Core formula: <strong>Input Data + Program -> Computer -> Output Data</strong>.</li>
                                </ul>
                            </li>
                            <li>
                                <strong>von Neumann Model:</strong>
                                <ul>
                                    <li>The architectural model for most modern computers.</li>
                                    <li><span class="highlight">Breakthrough concept: The Stored Program Concept</span>. Both the program (instructions) and data are stored in the same memory and share the same format (binary).</li>
                                </ul>
                            </li>
                        </ul>
                    `
                },
                questions: [
                    { q: { vi: "Mô hình nào định nghĩa khái niệm 'Stored Program Concept'?", en: "Which model defines the 'Stored Program Concept'?" }, o: [{ vi: "Mô hình Turing", en: "Turing Model" }, { vi: "Mô hình von Neumann", en: "von Neumann Model" }, { vi: "Mô hình Pascal", en: "Pascal Model" }, { vi: "Mô hình Babbage", en: "Babbage Model" }], a: 1, explanation: { vi: "Von Neumann = Chương trình trong Bộ nhớ.", en: "Von Neumann = Program in Memory." } }
                ]
            },
            chapter2: {
                 theory: {
                     vi: `
                        <h2>Chương 2: Hệ thống Số</h2>
                        <h3>1. Các hệ đếm cơ bản (Positional Number Systems)</h3>
                        <ul>
                            <li><strong>Khái niệm:</strong> Giá trị của một chữ số phụ thuộc vào <span class="highlight">vị trí</span> của nó trong chuỗi số. Mỗi vị trí có một trọng số là lũy thừa của cơ số.</li>
                            <li><strong>Các hệ đếm chính:</strong> Binary (2), Octal (8), Decimal (10), Hexadecimal (16).</li>
                        </ul>
                        <h3>2. Ví dụ về Chuyển đổi</h3>
                        <h4>Chuyển từ hệ bất kỳ sang Thập phân</h4>
                        <pre><strong>Ví dụ: (2AE)₁₆ sang thập phân (A=10, E=14)</strong>
N = 2×16² + 10×16¹ + 14×16⁰
  = 2×256 + 160 + 14 = 686₁₀</pre>
                        <h4>Chuyển từ Thập phân sang hệ bất kỳ</h4>
                        <pre><strong>Ví dụ: 35₁₀ sang nhị phân (chia cho 2)</strong>
35 / 2 = 17 dư 1  ↑
17 / 2 = 8  dư 1  |
 8 / 2 = 4  dư 0  | Đọc ngược từ dưới lên
 4 / 2 = 2  dư 0  |
 2 / 2 = 1  dư 0  |
 1 / 2 = 0  dư 1  ↑
Kết quả: (100011)₂</pre>
                        <h4>Chuyển đổi nhanh Binary ↔ Hexadecimal</h4>
                        <pre><strong>Ví dụ: (10011100010)₂ sang Hexadecimal (gom nhóm 4 bit)</strong>
  0100  1110  0010  (Thêm 0 vào đầu)
    ↓     ↓     ↓
    4     E     2
Kết quả: (4E2)₁₆</pre>
                    `,
                    en: `
                        <h2>Chapter 2: Number Systems</h2>
                        <h3>1. Positional Number Systems</h3>
                        <ul>
                            <li><strong>Concept:</strong> The value of a digit depends on its <span class="highlight">position</span> within the number string. Each position has a place value, which is a power of the base.</li>
                            <li><strong>Main Systems:</strong> Binary (2), Octal (8), Decimal (10), Hexadecimal (16).</li>
                        </ul>
                        <h3>2. Conversion Examples</h3>
                        <h4>Convert from Any Base to Decimal</h4>
                        <pre><strong>Example: (2AE)₁₆ to decimal (A=10, E=14)</strong>
N = 2×16² + 10×16¹ + 14×16⁰
  = 2×256 + 160 + 14 = 686₁₀</pre>
                        <h4>Convert from Decimal to Any Base</h4>
                        <pre><strong>Example: 35₁₀ to binary (divide by 2)</strong>
35 / 2 = 17 rem 1  ↑
17 / 2 = 8  rem 1  |
 8 / 2 = 4  rem 0  | Read in reverse
 4 / 2 = 2  rem 0  | order
 2 / 2 = 1  rem 0  |
 1 / 2 = 0  rem 1  ↑
Result: (100011)₂</pre>
                        <h4>Quick Conversion Binary ↔ Hexadecimal</h4>
                        <pre><strong>Example: (10011100010)₂ to Hexadecimal (group of 4 bits)</strong>
  0100  1110  0010  (Pad with leading zeros)
    ↓     ↓     ↓
    4     E     2
Result: (4E2)₁₆</pre>
                    `
                },
                questions: [
                     { q: { vi: "Một chữ số thập lục phân (hex digit) tương ứng với bao nhiêu bit?", en: "One hexadecimal digit corresponds to how many bits?"}, o: [ {vi: "2 bit", en: "2 bits"}, {vi: "3 bit", en: "3 bits"}, {vi: "4 bit", en: "4 bits"}, {vi: "8 bit", en: "8 bits"}], a: 2, explanation: {vi: "Vì 16 = 2⁴, mỗi chữ số thập lục phân có thể biểu diễn một tổ hợp duy nhất của 4 bit.", en: "Because 16 = 2⁴, each hexadecimal digit can represent a unique combination of 4 bits."}}
                ]
            },
            chapter3: {
                theory: {
                    vi: `
                        <h2>Chương 3: Lưu trữ Dữ liệu</h2>
                        <p>Chương này giải thích cách các loại dữ liệu khác nhau được biểu diễn dưới dạng các chuỗi bit (0 và 1) để máy tính có thể lưu trữ và xử lý.</p>
                        <h3>1. Lưu trữ số nguyên (Storing Integers)</h3>
                        <ul>
                            <li><strong>Số nguyên không dấu (Unsigned Integers):</strong> Dùng để biểu diễn các số không âm (0, 1, 2, ...). Với n bit, ta có thể biểu diễn các số từ 0 đến 2ⁿ-1.</li>
                            <li><strong>Số nguyên có dấu (Signed Integers):</strong>
                                <ul>
                                    <li><strong>Dấu và Độ lớn (Sign-and-Magnitude):</strong> Dùng bit đầu tiên làm bit dấu (0=dương, 1=âm). Có nhược điểm là tồn tại hai biểu diễn cho số 0 (+0 và -0).</li>
                                    <li><strong>Bù 2 (Two's Complement):</strong> Phương pháp tiêu chuẩn hiện nay. Nó chỉ có một biểu diễn cho số 0 và giúp đơn giản hóa các phép toán trừ.</li>
                                </ul>
                            </li>
                        </ul>
                    `,
                    en: `
                        <h2>Chapter 3: Data Storage</h2>
                        <p>This chapter explains how different data types are represented as bit patterns (0s and 1s) so they can be stored and processed by a computer.</p>
                        <h3>1. Storing Integers</h3>
                        <ul>
                            <li><strong>Unsigned Integers:</strong> Used to represent non-negative numbers (0, 1, 2, ...). With n bits, numbers from 0 to 2ⁿ-1 can be represented.</li>
                            <li><strong>Signed Integers:</strong>
                                <ul>
                                    <li><strong>Sign-and-Magnitude:</strong> Uses the first bit as a sign bit (0=positive, 1=negative). It has the drawback of having two representations for zero.</li>
                                    <li><strong>Two's Complement:</strong> The current standard method. It has only one representation for zero and simplifies subtraction operations.</li>
                                </ul>
                            </li>
                        </ul>
                    `
                },
                questions: [
                    { q: { vi: "Hầu hết các máy tính ngày nay sử dụng phương pháp biểu diễn số nguyên nào để lưu trữ số nguyên có dấu?", en: "Which integer representation do most computers today use to store signed integers?"}, o: [{vi: "Biểu diễn không dấu", en: "Unsigned representation"}, {vi: "Biểu diễn dấu-lượng", en: "Sign-and-magnitude representation"}, {vi: "Biểu diễn bù hai", en: "Two's complement representation"}, {vi: "Biểu diễn bù một", en: "One's complement representation"}], a: 2, explanation: {vi: "Bù hai là tiêu chuẩn vì nó giải quyết vấn đề hai số 0 và đơn giản hóa mạch logic cho phép trừ.", en: "Two's complement is the standard because it solves the two-zeros problem and simplifies the logic circuit for subtraction."}}
                ]
            },
            chapter4: {
                 theory: {
                    vi: `
                        <h2>Chương 4: Các Phép toán trên Dữ liệu</h2>
                        <h3>1. Phép toán Logic (Logic Operations)</h3>
                        <ul>
                            <li><strong>Ứng dụng: Dùng mặt nạ (Masking)</strong>
                                <ul>
                                    <li><span class="highlight">Unsetting (Xóa bit về 0):</span> Dùng phép <strong>AND</strong> với mặt nạ có bit 0 tại vị trí cần xóa.</li>
                                    <li><span class="highlight">Setting (Bật bit lên 1):</span> Dùng phép <strong>OR</strong> với mặt nạ có bit 1 tại vị trí cần bật.</li>
                                    <li><span class="highlight">Flipping (Lật bit):</span> Dùng phép <strong>XOR</strong> với mặt nạ có bit 1 tại vị trí cần lật.</li>
                                </ul>
                            </li>
                        </ul>
                        <h3>2. Ví dụ về Masking</h3>
                        <pre><strong>Ví dụ: Xóa (unset) 5 bit ngoài cùng bên trái của 10100110</strong>
  1010 0110   (Dữ liệu gốc)
& 0000 0111   (Mặt nạ AND - 0 ở vị trí cần xóa)
-----------
  0000 0110   (Kết quả)</pre>
                        <h3>3. Phép toán Số học (Arithmetic Operations)</h3>
                        <ul>
                            <li><span class="highlight">Phép trừ A - B được thực hiện bằng phép cộng: A + (Bù 2 của B)</span>.</li>
                        </ul>
                         <pre><strong>Ví dụ: (+24) + (-17) dùng số bù 2 8-bit</strong>
+24       = 0001 1000
-17       = 1110 1111  (Bù 2 của 17)
-------------------
Kết quả: (1)0000 0111  (Bỏ bit nhớ cuối)
          = 7₁₀ (Đúng)</pre>
                    `,
                    en: `
                        <h2>Chapter 4: Operations on Data</h2>
                        <h3>1. Logic Operations</h3>
                        <ul>
                            <li><strong>Application: Masking</strong>
                                <ul>
                                    <li><span class="highlight">Unsetting a bit (to 0):</span> Use <strong>AND</strong> with a mask that has a 0 at the desired position.</li>
                                    <li><span class="highlight">Setting a bit (to 1):</span> Use <strong>OR</strong> with a mask that has a 1 at the desired position.</li>
                                    <li><span class="highlight">Flipping a bit:</span> Use <strong>XOR</strong> with a mask that has a 1 at the desired position.</li>
                                </ul>
                            </li>
                        </ul>
                        <h3>2. Masking Examples</h3>
                        <pre><strong>Example: Unset the five leftmost bits of 10100110</strong>
  1010 0110   (Original Data)
& 0000 0111   (AND Mask - 0s where you want to clear)
-----------
  0000 0110   (Result)</pre>
                        <h3>3. Arithmetic Operations</h3>
                        <ul>
                            <li><span class="highlight">Subtraction A - B is performed as an addition: A + (Two's complement of B)</span>.</li>
                        </ul>
                         <pre><strong>Example: (+24) + (-17) using 8-bit two's complement</strong>
+24       = 0001 1000
-17       = 1110 1111  (Two's complement of 17)
-------------------
Result: (1)0000 0111  (Discard final carry)
          = 7₁₀ (Correct)</pre>
                    `
                },
                questions: [
                    { q: { vi: "Để 'unset' (tắt) một bit cụ thể (buộc về 0), ta nên sử dụng phép toán nào với một mặt nạ?", en: "To 'unset' (turn off) a specific bit (force to 0), which operation should be used with a mask?"}, o: [ {vi: "OR", en: "OR"}, {vi: "AND", en: "AND"}, {vi: "XOR", en: "XOR"}, {vi: "NOT", en: "NOT"}], a: 1, explanation: {vi: "AND với 0 sẽ luôn cho kết quả là 0.", en: "ANDing with 0 always results in 0."}}
                ]
            },
            chapter5: {
                 theory: {
                    vi: `
                        <h2>Chương 5: Tổ chức Máy tính</h2>
                        <h3>1. Các thành phần chính</h3>
                        <ul>
                            <li><strong>CPU (Central Processing Unit):</strong> "Bộ não" của máy tính. Gồm 3 phần: ALU (tính toán), Control Unit (điều khiển), và Registers (thanh ghi).</li>
                            <li><strong>Bộ nhớ chính (Main Memory):</strong> Thường là RAM, lưu trữ chương trình và dữ liệu đang chạy.</li>
                        </ul>
                        <h3>2. Phân cấp bộ nhớ (Memory Hierarchy)</h3>
                        <p>Tốc độ và giá thành giảm dần, dung lượng tăng dần:</p>
                        <p><span class="highlight">Registers → Cache → Main Memory → Storage (Ổ cứng)</span></p>
                        <h3>3. Chu kỳ máy (Machine Cycle)</h3>
                        <ul>
                             <li>Quá trình CPU thực thi một lệnh. Gồm 3 bước cơ bản:
                                <ol>
                                    <li><span class="highlight">Fetch (Nạp lệnh):</span> Lấy lệnh từ bộ nhớ.</li>
                                    <li><span class="highlight">Decode (Giải mã):</span> Hiểu xem lệnh yêu cầu làm gì.</li>
                                    <li><span class="highlight">Execute (Thực thi):</span> Thực hiện lệnh đó.</li>
                                </ol>
                            </li>
                        </ul>
                    `,
                    en: `
                        <h2>Chapter 5: Computer Organization</h2>
                        <h3>1. Main Components</h3>
                        <ul>
                           <li><strong>CPU (Central Processing Unit):</strong> The "brain" of the computer. Contains 3 parts: ALU (calculation), Control Unit (control), and Registers.</li>
                            <li><strong>Main Memory:</strong> Usually RAM, stores currently running programs and data.</li>
                        </ul>
                        <h3>2. Memory Hierarchy</h3>
                        <p>Speed and cost decrease, while capacity increases:</p>
                        <p><span class="highlight">Registers → Cache → Main Memory → Storage (Hard Drive)</span></p>
                        <h3>3. Machine Cycle</h3>
                        <ul>
                             <li>The repetitive process by which the CPU executes one instruction. Consists of 3 basic steps:
                                <ol>
                                    <li><span class="highlight">Fetch:</span> Get the instruction from memory.</li>
                                    <li><span class="highlight">Decode:</span> Understand what the instruction wants to do.</li>
                                    <li><span class="highlight">Execute:</span> Perform the instruction.</li>
                                </ol>
                            </li>
                        </ul>
                    `
                },
                questions: [
                    { q: { vi: "Ba thành phần chính của CPU là gì?", en: "What are the three main components of a CPU?" }, o: [{ vi: "RAM, ROM, và Cache", en: "RAM, ROM, and Cache" }, { vi: "ALU, Control Unit, và Registers", en: "ALU, Control Unit, and Registers" }, { vi: "Data Bus, Address Bus, và Control Bus", en: "Data Bus, Address Bus, and Control Bus" }], a: 1, explanation: { vi: "CPU có bộ phận tính toán (ALU), bộ phận chỉ huy (Control Unit), và bộ nhớ siêu nhanh tại chỗ (Registers).", en: "The CPU has a calculation part (ALU), a command part (Control Unit), and super-fast local memory (Registers)." } }
                ]
            }
        };
        // --- END: NGÂN HÀNG CÂU HỎI VÀ LÝ THUYẾT ---

        // --- START: JAVASCRIPT LOGIC (HOÀN CHỈNH) ---
        let currentLang = 'vi';
        let currentChapter = 'chapter1';
        let quizState = {};

        document.addEventListener('DOMContentLoaded', () => {
            renderAllContent();
        });

        function renderAllContent() {
            const tabContent = document.querySelector('.tab-content');
            tabContent.innerHTML = '';
            let isFirstChapter = true;
            for (const chapterId in contentData) {
                const chapterDiv = document.createElement('div');
                chapterDiv.id = chapterId;
                chapterDiv.className = isFirstChapter ? 'tab-pane active' : 'tab-pane';
                isFirstChapter = false;

                chapterDiv.innerHTML = `
                    <div class="theory-view">
                        <div class="theory-content"></div>
                        <div class="button-group">
                            <button class="primary-button" onclick="showQuizSetup('${chapterId}')" data-lang-key="startQuiz"></button>
                            <button class="info-button" onclick="askAI()" data-lang-key="askAI"></button>
                        </div>
                    </div>
                    <div class="quiz-view">
                        <div class="quiz-setup">
                            <h3 data-lang-key="quizSetupTitle"></h3>
                            <div>
                                <label data-lang-key="numQuestions"></label>
                                <input type="number" id="num-questions-${chapterId}" value="10" min="1" max="${contentData[chapterId].questions.length}">
                            </div>
                            <div>
                                <button class="primary-button" onclick="startQuiz('${chapterId}')" data-lang-key="start"></button>
                                <button class="secondary-button" onclick="showTheory('${chapterId}')" data-lang-key="backToTheory"></button>
                            </div>
                        </div>
                        <div class="quiz-container" style="display:none;">
                            <div id="question-text-${chapterId}" class="quiz-question"></div>
                            <div id="quiz-options-${chapterId}" class="quiz-options"></div>
                            <div id="explanation-${chapterId}"></div>
                            <div class="button-group">
                                <button onclick="nextQuestion('${chapterId}')" id="next-btn-${chapterId}" class="primary-button" data-lang-key="nextQuestion" style="display:none;"></button>
                            </div>
                        </div>
                        <div class="quiz-results" style="display:none;">
                            <h3 data-lang-key="resultsTitle"></h3>
                            <p id="score-${chapterId}"></p>
                            <button class="secondary-button" onclick="showTheory('${chapterId}')" data-lang-key="backToTheory"></button>
                            <button class="primary-button" onclick="showQuizSetup('${chapterId}')" data-lang-key="retakeQuiz"></button>
                        </div>
                    </div>
                `;
                tabContent.appendChild(chapterDiv);
            }
            updateAllVisibleText();
        }

        function switchTab(chapterId) {
            currentChapter = chapterId;
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(chapterId).classList.add('active');
            
            document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.tab-link[onclick="switchTab('${chapterId}')"]`).classList.add('active');
        }

        function switchLanguage(lang) {
            if (currentLang === lang) return;
            currentLang = lang;
            document.querySelectorAll('.lang-switcher button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.lang-switcher button[onclick="switchLanguage('${lang}')"]`).classList.add('active');
            updateAllVisibleText();
        }
        
        const translations = {
            vi: {
                title: "CSI FPTU - Công cụ Ôn tập Nâng cao",
                subtitle: "Chọn chương để học lý thuyết hoặc làm bài tập trắc nghiệm.",
                vietnamese: "Tiếng Việt", english: "English",
                ch1: "Chương 1", ch2: "Chương 2", ch3: "Chương 3", ch4: "Chương 4", ch5: "Chương 5",
                startQuiz: "Làm bài tập", quizSetupTitle: "Thiết lập bài trắc nghiệm",
                numQuestions: "Số lượng câu hỏi:", start: "Bắt đầu",
                backToTheory: "Quay lại Lý thuyết", nextQuestion: "Câu tiếp theo",
                resultsTitle: "Kết quả", scoreText: "Bạn đã trả lời đúng",
                retakeQuiz: "Làm lại bài", askAI: "Hỏi AI"
            },
            en: {
                title: "CSI FPTU - Advanced Study Tool",
                subtitle: "Select a chapter to study theory or take a multiple-choice quiz.",
                vietnamese: "Vietnamese", english: "English",
                ch1: "Chapter 1", ch2: "Chapter 2", ch3: "Chapter 3", ch4: "Chapter 4", ch5: "Chapter 5",
                startQuiz: "Start Quiz", quizSetupTitle: "Quiz Setup",
                numQuestions: "Number of questions:", start: "Start",
                backToTheory: "Back to Theory", nextQuestion: "Next Question",
                resultsTitle: "Results", scoreText: "You answered correctly",
                retakeQuiz: "Retake Quiz", askAI: "Ask AI"
            }
        };

        function updateAllVisibleText() {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });

            for (const chapterId in contentData) {
                const theoryDiv = document.querySelector(`#${chapterId} .theory-content`);
                if (theoryDiv) {
                    theoryDiv.innerHTML = contentData[chapterId].theory[currentLang];
                }
            }

            if (quizState[currentChapter] && quizState[currentChapter].isActive) {
                redisplayCurrentQuestion();
            }
        }

        function redisplayCurrentQuestion() {
            const state = quizState[currentChapter];
            if (!state || !state.isActive || state.currentQuestionIndex >= state.questions.length) return;

            const question = state.questions[state.currentQuestionIndex];
            document.getElementById(`question-text-${currentChapter}`).textContent = `(${state.currentQuestionIndex + 1}/${state.questions.length}) ${question.q[currentLang]}`;
            
            const options = document.querySelectorAll(`#quiz-options-${currentChapter} button`);
            options.forEach((button, index) => {
                button.textContent = question.o[index][currentLang];
            });

            const explanationDiv = document.getElementById(`explanation-${currentChapter}`);
            if (explanationDiv.innerHTML !== '') {
                const explanationText = question.explanation ? question.explanation[currentLang] : '';
                explanationDiv.innerHTML = `<div class="explanation-box"><strong>💡 ${currentLang === 'vi' ? 'Giải thích' : 'Explanation'}:</strong> ${explanationText}</div>`;
            }
        }
        
        function showQuizSetup(chapterId) {
            document.querySelector(`#${chapterId} .theory-view`).style.display = 'none';
            document.querySelector(`#${chapterId} .quiz-view`).style.display = 'block';
            document.querySelector(`#${chapterId} .quiz-setup`).style.display = 'block';
            document.querySelector(`#${chapterId} .quiz-container`).style.display = 'none';
            document.querySelector(`#${chapterId} .quiz-results`).style.display = 'none';
        }

        function showTheory(chapterId) {
            if(quizState[chapterId]) quizState[chapterId].isActive = false;
            document.querySelector(`#${chapterId} .theory-view`).style.display = 'block';
            document.querySelector(`#${chapterId} .quiz-view`).style.display = 'none';
        }

        function startQuiz(chapterId) {
            const allQuestions = contentData[chapterId].questions;
            const numQuestionsInput = document.getElementById(`num-questions-${chapterId}`);
            let numQuestions = parseInt(numQuestionsInput.value);
            if (isNaN(numQuestions) || numQuestions <= 0 || numQuestions > allQuestions.length) {
                numQuestions = Math.min(10, allQuestions.length);
                numQuestionsInput.value = numQuestions;
            }
            
            const questions = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, numQuestions);

            quizState[chapterId] = { questions, currentQuestionIndex: 0, score: 0, isActive: true };

            document.querySelector(`#${chapterId} .quiz-setup`).style.display = 'none';
            document.querySelector(`#${chapterId} .quiz-container`).style.display = 'block';
            document.querySelector(`#${chapterId} .quiz-results`).style.display = 'none';
            
            displayQuestion(chapterId);
        }

        function displayQuestion(chapterId) {
            const state = quizState[chapterId];
            if (state.currentQuestionIndex >= state.questions.length) {
                showResults(chapterId);
                return;
            }

            const question = state.questions[state.currentQuestionIndex];
            document.getElementById(`question-text-${chapterId}`).textContent = `(${state.currentQuestionIndex + 1}/${state.questions.length}) ${question.q[currentLang]}`;
            
            const optionsDiv = document.getElementById(`quiz-options-${chapterId}`);
            optionsDiv.innerHTML = '';
            question.o.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option[currentLang];
                button.onclick = () => selectAnswer(chapterId, index);
                optionsDiv.appendChild(button);
            });

            document.getElementById(`explanation-${chapterId}`).innerHTML = '';
            document.getElementById(`next-btn-${chapterId}`).style.display = 'none';
        }

        function selectAnswer(chapterId, selectedIndex) {
            const state = quizState[chapterId];
            const question = state.questions[state.currentQuestionIndex];
            const correctIndex = question.a;
            
            const options = document.querySelectorAll(`#${chapterId} .quiz-options button`);
            options.forEach(button => button.disabled = true);

            if (selectedIndex === correctIndex) {
                options[selectedIndex].classList.add('correct');
                state.score++;
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[correctIndex].classList.add('correct');
                const explanationDiv = document.getElementById(`explanation-${chapterId}`);
                if(question.explanation) {
                    explanationDiv.innerHTML = `<div class="explanation-box"><strong>💡 ${currentLang === 'vi' ? 'Giải thích' : 'Explanation'}:</strong> ${question.explanation[currentLang]}</div>`;
                }
            }
            document.getElementById(`next-btn-${chapterId}`).style.display = 'inline-block';
        }

        function nextQuestion(chapterId) {
            quizState[chapterId].currentQuestionIndex++;
            displayQuestion(chapterId);
        }

        function showResults(chapterId) {
            const state = quizState[chapterId];
            state.isActive = false;
            document.querySelector(`#${chapterId} .quiz-container`).style.display = 'none';
            const resultsDiv = document.querySelector(`#${chapterId} .quiz-results`);
            resultsDiv.style.display = 'block';
            
            const scoreText = translations[currentLang].scoreText;
            document.getElementById(`score-${chapterId}`).textContent = `${scoreText} ${state.score} / ${state.questions.length} câu.`;
        }

        function askAI() {
            const activeChapter = document.querySelector('.tab-pane.active');
            const titleElement = activeChapter.querySelector('.theory-content h2');
            if (titleElement) {
                let topic = titleElement.textContent.trim();
                // Loại bỏ số chương để câu hỏi tự nhiên hơn
                topic = topic.replace(/Chapter \d+:|Chương \d+:/i, '').trim();

                // Tạo câu hỏi cụ thể cho AI
                const promptText = currentLang === 'vi' 
                    ? `Hãy giải thích chi tiết về chủ đề sau trong Khoa học máy tính: "${topic}"`
                    : `Please provide a detailed explanation of the following topic in Computer Science: "${topic}"`;

                const encodedPrompt = encodeURIComponent(promptText);
                // Dẫn thẳng đến Google Gemini với câu hỏi đã được điền sẵn
                const url = `https://gemini.google.com/app?prompt=${encodedPrompt}`;
                
                window.open(url, '_blank');
            }
        }
    </script>
</body>
</html>
